---
import Layout from "../../layouts/Layout.astro";
import NoteThumbnail from "../../components/NoteThumbnail.astro";
import NoteTag from "../../components/NoteTag.astro";
import type { MarkdownInstance } from "astro";

interface Frontmatter {
  title: string;
  date?: string;
  tags?: string[];
}

const notes = Object.values(
  import.meta.glob<MarkdownInstance<Frontmatter>>("./*.md", { eager: true }),
);
const allTags = [
  ...new Set(notes.flatMap((note) => note.frontmatter.tags || [])),
];
---

<Layout title="Personal Notes">
  <h1 class="text-3xl font-bold mb-8 text-primary-600">Personal Notes</h1>

  {
    allTags.length > 0 && (
      <div class="mb-8">
        <div class="text-slate-600 mb-2">
          Filter by tags (click to select multiple):
        </div>
        <div class="flex flex-wrap gap-2" id="tag-filters">
          {allTags.map((tag) => (
            <NoteTag
              tag={tag}
              onClick={() => {}}
              data-tag={tag}
              class="tag-button border-2 border-transparent"
            />
          ))}
          <button
            id="clear-filters"
            class="hidden text-sm text-red-500 hover:underline px-3 py-1"
          >
            Clear filters
          </button>
        </div>
      </div>
    )
  }

  <div class="grid gap-4" id="notes-grid">
    {
      notes.map((note) => (
        <NoteThumbnail
          note={note}
          data-tags={JSON.stringify(note.frontmatter.tags || [])}
        />
      ))
    }
  </div>

  <script>
    const tagButtons = document.querySelectorAll(".tag-button");
    const clearButton = document.getElementById("clear-filters");
    const noteCards = document.querySelectorAll(".note-card");
    let selectedTags = new Set();

    function updateVisibility() {
      if (selectedTags.size === 0) {
        noteCards.forEach((card) => card.classList.remove("hidden"));
        if (clearButton) clearButton.classList.add("hidden");
        return;
      }

      if (clearButton) clearButton.classList.remove("hidden");
      noteCards.forEach((card) => {
        // @ts-ignore
        const cardTags = JSON.parse(card.dataset.tags || "[]");

        // AND logic: Note must have ALL selected tags
        const hasAllTags = [...selectedTags].every((tag) =>
          cardTags.includes(tag),
        );

        if (hasAllTags) {
          card.classList.remove("hidden");
        } else {
          card.classList.add("hidden");
        }
      });
    }

    tagButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        // @ts-ignore
        const tag = btn.dataset.tag;
        if (selectedTags.has(tag)) {
          selectedTags.delete(tag);
          btn.classList.remove(
            "!bg-primary-500",
            "!text-white",
            "hover:!bg-primary-600",
          );
        } else {
          selectedTags.add(tag);
          btn.classList.add(
            "!bg-primary-500",
            "!text-white",
            "hover:!bg-primary-600",
          );
        }
        updateVisibility();
      });
    });

    clearButton?.addEventListener("click", () => {
      selectedTags.clear();
      tagButtons.forEach((btn) => {
        btn.classList.remove(
          "!bg-primary-500",
          "!text-white",
          "hover:!bg-primary-600",
        );
      });
      updateVisibility();
    });
  </script>
</Layout>
