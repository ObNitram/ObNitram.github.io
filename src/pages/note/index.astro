---
import Layout from "../../layouts/Layout.astro";
import NoteThumbnail from "../../components/NoteThumbnail.astro";
import NoteTag from "../../components/NoteTag.astro";
import { getNotesWithReadTime } from "../../utils/notes";

const notesWithReadTime = await getNotesWithReadTime();
const allTags = [
  ...new Set(notesWithReadTime.flatMap((n) => n.note.data.tags || [])),
];
---

<Layout title="Personal Notes">
  <h1 class="text-3xl font-bold mb-8 text-primary-600">Personal Notes</h1>

  <div class="mb-6">
    <input
      type="text"
      id="search-input"
      placeholder="Search notes... (e.g. 'tag1/tag2/title')"
      class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
    />
  </div>

  {
    allTags.length > 0 && (
      <div class="mb-8">
        <div class="text-slate-600 mb-2">
          Filter by tags (click to select multiple):
        </div>
        <div class="flex flex-wrap gap-2" id="tag-filters">
          {allTags.map((tag) => (
            <NoteTag
              tag={tag}
              onClick={() => {}}
              data-tag={tag}
              class="tag-button border-2 border-transparent"
            />
          ))}
          <button
            id="clear-filters"
            class="hidden text-sm text-red-500 hover:underline px-3 py-1"
          >
            Clear filters
          </button>
        </div>
      </div>
    )
  }

  <div class="grid gap-4" id="notes-grid">
    {
      notesWithReadTime.map(({ note, readTime }) => (
        <NoteThumbnail
          note={note}
          readTime={readTime}
          data-tags={JSON.stringify(note.data.tags || [])}
          data-title={note.data.title.toLowerCase()}
        />
      ))
    }
  </div>

  <script>
    import { parseSearchQuery, isCardVisible } from "../../utils/search";

    const tagButtons = document.querySelectorAll(".tag-button");
    const clearButton = document.getElementById("clear-filters");
    const searchInput = document.getElementById("search-input");
    const noteCards = document.querySelectorAll(".note-card");
    let selectedTags = new Set<string>();
    let searchQuery = "";
    let selectedIndex = 0;
    let visibleCards: Element[] = [];

    function updateSelection() {
      visibleCards.forEach((card, index) => {
        if (index === selectedIndex) {
          card.classList.add(
            "!border-primary-400",
            "ring-1",
            "ring-primary-400",
          );
          card.scrollIntoView({ behavior: "smooth", block: "nearest" });
        } else {
          card.classList.remove(
            "!border-primary-400",
            "ring-1",
            "ring-primary-400",
          );
        }
      });
    }

    function updateVisibility() {
      visibleCards = [];
      const { searchTags, term, isPath } = parseSearchQuery(searchQuery);
      const hasActiveFilters =
        selectedTags.size > 0 || searchTags.length > 0 || term.length > 0;

      if (clearButton) {
        if (hasActiveFilters) clearButton.classList.remove("hidden");
        else clearButton.classList.add("hidden");
      }

      noteCards.forEach((card) => {
        // @ts-ignore
        const cardTags = JSON.parse(card.dataset.tags || "[]");
        // @ts-ignore
        const cardTitle = card.dataset.title || "";

        let isVisible = true;

        if (hasActiveFilters) {
          isVisible = isCardVisible(
            cardTags,
            cardTitle,
            selectedTags,
            searchTags,
            term,
            isPath,
          );
        }

        if (isVisible) {
          card.classList.remove("hidden");
          visibleCards.push(card);
        } else {
          card.classList.add("hidden");
        }
      });

      selectedIndex = 0;
      updateSelection();
    }

    // Initialize visibleCards
    updateVisibility();

    searchInput?.addEventListener("input", (e) => {
      // @ts-ignore
      searchQuery = e.target.value.toLowerCase();
      updateVisibility();
    });

    searchInput?.addEventListener("keydown", (e) => {
      if (visibleCards.length === 0) return;

      if (e.key === "Enter") {
        e.preventDefault();
        const link = visibleCards[selectedIndex]?.querySelector("a");
        link?.click();
      } else if (
        e.key === "ArrowDown" ||
        e.key === "ArrowRight" ||
        e.key === "Tab"
      ) {
        e.preventDefault();
        selectedIndex = (selectedIndex + 1) % visibleCards.length;
        updateSelection();
      } else if (e.key === "ArrowUp" || e.key === "ArrowLeft") {
        e.preventDefault();
        selectedIndex =
          (selectedIndex - 1 + visibleCards.length) % visibleCards.length;
        updateSelection();
      }
    });

    tagButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        // @ts-ignore
        const tag = btn.dataset.tag;
        if (selectedTags.has(tag)) {
          selectedTags.delete(tag);
          btn.classList.remove(
            "!bg-primary-500",
            "!text-white",
            "hover:!bg-primary-600",
          );
        } else {
          selectedTags.add(tag);
          btn.classList.add(
            "!bg-primary-500",
            "!text-white",
            "hover:!bg-primary-600",
          );
        }
        updateVisibility();
      });
    });

    clearButton?.addEventListener("click", () => {
      selectedTags.clear();
      searchQuery = "";
      if (searchInput) {
        // @ts-ignore
        searchInput.value = "";
      }
      tagButtons.forEach((btn) => {
        btn.classList.remove(
          "!bg-primary-500",
          "!text-white",
          "hover:!bg-primary-600",
        );
      });
      updateVisibility();
    });
  </script>
</Layout>
