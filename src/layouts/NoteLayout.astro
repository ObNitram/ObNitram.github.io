---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import NoteTag from "../components/NoteTag.astro";
import SEO from "../components/SEO.astro";
import { Icon } from "astro-icon/components";
import { siteConfig } from "../config";

interface Heading {
    depth: number;
    slug: string;
    text: string;
}

interface Props {
    frontmatter?: {
        title: string;
        tags?: string[];
        description?: string;
        // Tailles des titres (Tailwind classes)
        h1Size?: string;
        h2Size?: string;
        h3Size?: string;
        h4Size?: string;
        // Taille du texte
        textSize?: string;
        // Couleurs
        textColor?: string;
        headingColor?: string;
        linkColor?: string;
        linkHoverColor?: string;
        // Largeur max du contenu
        maxWidth?: string;
        [key: string]: any;
    };
    headings?: Heading[];
    slug?: string;
}

const { frontmatter, headings = [], slug = "" } = Astro.props;
const pageTitle = frontmatter?.title || "Note - Martin Guillemot";
const tags = frontmatter?.tags || [];
const date = frontmatter?.date;
const description = frontmatter?.description || `${pageTitle} - Notes de Martin Guillemot`;
const editUrl = `${siteConfig.gitUrlForModification}${slug}.mdx`;

// Filtrer pour n'avoir que les h2 et h3
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

const formattedDate = date
    ? new Date(date).toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
      })
    : undefined;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>{pageTitle}</title>
        <SEO 
            title={pageTitle}
            description={description}
            type="article"
            publishedTime={date}
            tags={tags}
        />
        <style is:global>
            /* GitHub Alert Styles */
            .markdown-alert {
                padding: 0.25rem 0.75rem;
                margin-bottom: 0.5rem;
                border-left: 0.25em solid;
                border-radius: 0.25rem;
            }

            .markdown-alert > *:first-child {
                margin-top: 0 !important;
            }

            .markdown-alert > *:last-child {
                margin-bottom: 0 !important;
            }

            .markdown-alert p {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }

            .markdown-alert-title {
                display: flex;
                align-items: center;
                font-weight: bold;
                font-size: 0.9em;
                margin-bottom: 0;
            }

            .markdown-alert-title svg {
                margin-right: 0.5rem;
                width: 16px;
                height: 16px;
            }

            /* Note */
            .markdown-alert-note {
                border-color: #0969da;
                background-color: #ddf4ff;
                color: #0969da;
            }
            .markdown-alert-note .markdown-alert-title {
                color: #0969da;
            }

            /* Tip */
            .markdown-alert-tip {
                border-color: #1a7f37;
                background-color: #dafbe1;
                color: #1a7f37;
            }
            .markdown-alert-tip .markdown-alert-title {
                color: #1a7f37;
            }

            /* Important */
            .markdown-alert-important {
                border-color: #8250df;
                background-color: #f6f0ff;
                color: #8250df;
            }
            .markdown-alert-important .markdown-alert-title {
                color: #8250df;
            }

            /* Warning */
            .markdown-alert-warning {
                border-color: #9a6700;
                background-color: #fff8c5;
                color: #9a6700;
            }
            .markdown-alert-warning .markdown-alert-title {
                color: #9a6700;
            }

            /* Caution */
            .markdown-alert-caution {
                border-color: #d1242f;
                background-color: #ffebe9;
                color: #d1242f;
            }
            .markdown-alert-caution .markdown-alert-title {
                color: #d1242f;
            }
        </style>
    </head>
    <body class="flex flex-col min-h-screen bg-slate-100 text-slate-800">
        <Header />

        <div class="flex-grow flex">
            <!-- Table of Contents - Desktop only -->
            {
                tocHeadings.length > 0 && (
                    <aside class="hidden xl:block w-64 shrink-0">
                        <nav class="sticky top-8 p-6 ml-4 mt-8">
                            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">
                                Sommaire
                            </h2>
                            <ul class="space-y-2 text-sm border-l-2 border-slate-200">
                                {tocHeadings.map((heading) => (
                                    <li>
                                        <a
                                            href={`#${heading.slug}`}
                                            class:list={[
                                                "block py-1 text-slate-500 hover:text-primary-600 transition-colors border-l-2 -ml-[2px]",
                                                "hover:border-primary-600 border-transparent",
                                                heading.depth === 2
                                                    ? "pl-4 font-medium"
                                                    : "pl-8 text-slate-400",
                                            ]}
                                        >
                                            {heading.text}
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </nav>
                    </aside>
                )
            }

            <!-- Main content -->
            <main
                class="flex-grow container mx-auto px-0 md:px-4 py-8 max-w-4xl"
            >
                <div class="mb-6 px-4 md:px-0">
                    <a
                        href="/note"
                        class="inline-flex items-center text-sm font-medium text-slate-500 hover:text-primary-600 transition-colors"
                    >
                        <Icon
                            name="heroicons-outline:arrow-left"
                            class="h-4 w-4 mr-1"
                        />
                        Back to notes
                    </a>
                </div>

                <article
                    class="bg-white md:rounded-2xl shadow-sm border-y md:border border-slate-200 overflow-hidden"
                >
                    <div class="px-4 pt-8 pb-8 md:px-12 md:pt-12">
                        <header class="mb-8 border-b border-slate-100 pb-8">
                            <h1
                                class="text-2xl md:text-4xl font-extrabold text-slate-900 tracking-tight mb-4"
                            >
                                {pageTitle}
                            </h1>

                            <div
                                class="flex flex-wrap items-center gap-4 text-sm text-slate-500"
                            >
                                {
                                    formattedDate && (
                                        <div class="flex items-center gap-1 leading-none">
                                            <Icon
                                                name="heroicons-outline:calendar"
                                                class="h-4 w-4 mr-1 text-slate-400 shrink-0 align-middle"
                                            />
                                            {formattedDate}
                                        </div>
                                    )
                                }

                                {
                                    tags.length > 0 && (
                                        <div class="flex flex-wrap gap-2">
                                            {tags.map((tag) => (
                                                <NoteTag tag={tag} />
                                            ))}
                                        </div>
                                    )
                                }
                            </div>
                        </header>

                        <div
                            class="prose prose-slate prose-sm md:prose-base max-w-none prose-headings:font-bold prose-headings:text-slate-900 prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline prose-img:rounded-xl"
                        >
                            <slot />
                        </div>

                        <!-- Edit on GitHub button -->
                        <div class="mt-12 pt-6 border-t border-slate-200">
                            <a
                                href={editUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-2 text-sm text-slate-500 hover:text-primary-600 transition-colors"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Proposer une modification
                            </a>
                        </div>
                    </div>
                </article>
            </main>

            <!-- Spacer for symmetry on very large screens -->
            <div class="hidden xl:block w-64 shrink-0"></div>
        </div>

        <Footer />

        <!-- Mobile TOC Button & Panel -->
        {tocHeadings.length > 0 && (
            <>
                <!-- Floating button -->
                <button
                    id="toc-mobile-btn"
                    class="xl:hidden fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 bg-primary-600 text-white rounded-full shadow-lg hover:bg-primary-700 transition-all"
                    aria-label="Ouvrir le sommaire"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
                    </svg>
                    <span class="text-sm font-medium">Sommaire</span>
                </button>

                <!-- Backdrop -->
                <div
                    id="toc-backdrop"
                    class="xl:hidden fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
                ></div>

                <!-- Bottom sheet -->
                <div
                    id="toc-mobile-panel"
                    class="xl:hidden fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out max-h-[70vh] overflow-hidden"
                >
                    <div class="flex items-center justify-between p-4 border-b border-slate-200">
                        <h2 class="text-lg font-bold text-slate-900">Sommaire</h2>
                        <button
                            id="toc-mobile-close"
                            class="p-2 text-slate-400 hover:text-slate-600 transition-colors"
                            aria-label="Fermer le sommaire"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <nav class="p-4 overflow-y-auto max-h-[calc(70vh-60px)]">
                        <ul class="space-y-1">
                            {tocHeadings.map((heading) => (
                                <li>
                                    <a
                                        href={`#${heading.slug}`}
                                        class:list={[
                                            "toc-mobile-link block py-2 px-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-primary-600 transition-colors",
                                            heading.depth === 2 ? "font-medium" : "pl-6 text-sm text-slate-500",
                                        ]}
                                    >
                                        {heading.text}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </nav>
                </div>
            </>
        )}

        <!-- Script pour highlight du sommaire au scroll -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const desktopTocLinks = document.querySelectorAll("aside nav a");
                const headings = document.querySelectorAll(
                    "article h2[id], article h3[id]",
                );

                if (desktopTocLinks.length === 0 || headings.length === 0) return;

                const observerOptions = {
                    rootMargin: "-80px 0px -70% 0px",
                    threshold: 0,
                };

                let currentActive: Element | null = null;

                function setActiveLink(tocLink: Element | null) {
                    // Remove active state from previous
                    if (currentActive) {
                        currentActive.classList.remove(
                            "border-primary-600",
                            "text-primary-600",
                        );
                        currentActive.classList.add(
                            "border-transparent",
                            "text-slate-500",
                        );
                    }

                    if (tocLink) {
                        tocLink.classList.remove(
                            "border-transparent",
                            "text-slate-500",
                            "text-slate-400",
                        );
                        tocLink.classList.add(
                            "border-primary-600",
                            "text-primary-600",
                        );
                        currentActive = tocLink;
                    }
                }

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            const id = entry.target.getAttribute("id");
                            const tocLink = document.querySelector(
                                `aside nav a[href="#${id}"]`,
                            );
                            setActiveLink(tocLink);
                        }
                    });
                }, observerOptions);

                headings.forEach((heading) => observer.observe(heading));

                // Update on click immediately
                desktopTocLinks.forEach((link) => {
                    link.addEventListener("click", (e) => {
                        setActiveLink(link);
                    });
                });
            });

            // Mobile TOC functionality
            const tocBtn = document.getElementById('toc-mobile-btn');
            const tocPanel = document.getElementById('toc-mobile-panel');
            const tocBackdrop = document.getElementById('toc-backdrop');
            const tocClose = document.getElementById('toc-mobile-close');
            const tocLinks = document.querySelectorAll('.toc-mobile-link');

            function openToc() {
                tocPanel?.classList.remove('translate-y-full');
                tocBackdrop?.classList.remove('opacity-0', 'pointer-events-none');
                tocBackdrop?.classList.add('opacity-100');
                document.body.style.overflow = 'hidden';
            }

            function closeToc() {
                tocPanel?.classList.add('translate-y-full');
                tocBackdrop?.classList.add('opacity-0', 'pointer-events-none');
                tocBackdrop?.classList.remove('opacity-100');
                document.body.style.overflow = '';
            }

            tocBtn?.addEventListener('click', openToc);
            tocClose?.addEventListener('click', closeToc);
            tocBackdrop?.addEventListener('click', closeToc);

            // Close when clicking a link
            tocLinks.forEach(link => {
                link.addEventListener('click', () => {
                    closeToc();
                });
            });

            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeToc();
            });
        </script>
    </body>
</html>
